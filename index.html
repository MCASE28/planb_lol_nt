<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>플랜비 롤 내전 룰렛</title>
    <style>
        :root {
            /* 1. 파라미터 설정 */
            --user-icon-width: 80px;
            --user-icon-height: 80px;
            --title-img-width: 300px;
            --title-img-height: auto;
            
            /* 휠 및 아이콘 크기 설정 */
            --wheel-size: 350px;           /* 룰렛 전체 크기 */
            --pos-icon-size-wheel: 70px;   /* 룰렛 내 포지션 아이콘 크기 */
            --user-font-size-wheel: 1.1rem; /* 룰렛 내 유저 이름 폰트 크기 */
            --wheel-border-color: rgba(255, 255, 255, 0.2); /* 룰렛 칸 경계선 색상 */

            /* 멈추는 딜레이 설정 (밀리초) */
            --delay-team: 500;        /* 팀 결정 즉시 멈춤 */
            --delay-user: 2000;     /* 유저 휠 멈춤 딜레이 */
            --delay-position: 4000; /* 포지션 휠 멈춤 딜레이 */
            --delay-next-spin: 2000; /* 결과 나온 후 다음 스핀까지 클릭 방지 딜레이 */
            
            --result-text-size: 2rem; /* 결과 텍스트 크기 */

            --red-color: #ff4d4d;
            --blue-color: #4d79ff;
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Malgun Gothic', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }

        #result-display {
            font-size: var(--result-text-size);
            font-weight: bold;
            margin-bottom: 20px;
            min-height: 1.2em; /* 공간 확보 */
            text-align: center;
            color: #f0d028; /* 기본 강조색 */
        }


        #title-container img {
            width: var(--title-img-width);
            height: var(--title-img-height);
            margin-bottom: 20px;
        }

        /* STEP 1: 유저 선택 화면 */
        #user-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 1200px;
        }

        .selection-container {
            display: flex;
            flex-direction: row;
            gap: 20px;
            justify-content: center;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .user-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .user-item {
            width: var(--user-icon-width);
            text-align: center;
            border: 2px solid transparent;
            padding: 5px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* Preset User Item only - Clickable Wrapper */
        .user-item.preset {
            cursor: pointer;
            transition: transform 0.2s;
            opacity: 0.5;
        }

        .user-item.preset.active {
            opacity: 1;
            border-color: #f0d028;
            background-color: rgba(240, 208, 40, 0.1);
        }

        .user-item.preset:hover {
            transform: scale(1.05);
        }

        /* Custom User Item */
        .user-item.custom {
            opacity: 1; /* Always visible, activity toggled via icon */
        }
        
        .user-item.custom .user-icon {
            cursor: pointer;
            opacity: 0.3;
            transition: opacity 0.2s, transform 0.2s;
            fill: #e3e3e3; /* SVG fill */
        }

        .user-item.custom.active {
            border-color: #f0d028;
            background-color: rgba(240, 208, 40, 0.1);
        }

        .user-item.custom.active .user-icon {
            opacity: 1;
            transform: scale(1.05);
        }

        .user-icon {
            width: var(--user-icon-height);
            height: var(--user-icon-height);
            border-radius: 50%; /* Make circular */
            overflow: hidden;   /* Clip content to circle */
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #333;
        }

        .user-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-icon svg {
            width: 100%;
            height: 100%;
        }

        .user-name {
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .custom-name-input {
            width: 100%;
            background: transparent;
            border: 1px solid #555;
            color: #fff;
            text-align: center;
            padding: 2px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.9rem;
        }
        
        .custom-name-input:focus {
            outline: none;
            border-color: #f0d028;
            background: #333;
        }

        .divider {
            width: 2px;
            background-color: #555;
            align-self: stretch;
            margin: 0 10px;
        }

        .controls-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            width: 100%;
        }

        #confirm-btn {
            padding: 10px 40px;
            font-size: 1.2rem;
            background-color: #444;
            color: #888;
            border: none;
            border-radius: 5px;
            cursor: not-allowed;
        }

        #confirm-btn.enabled {
            background-color: #f0d028;
            color: #000;
            cursor: pointer;
            font-weight: bold;
        }

        .custom-setting-area {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #custom-count-select {
            padding: 5px 10px;
            border-radius: 5px;
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
        }

        /* STEP 2: 룰렛 화면 (슬롯머신 스타일) */
        #roulette-container {
            display: none;
            width: 100%;
            max-width: 1200px; /* 좀 더 넓게 */
            flex-direction: column;
            align-items: center;
        }

        .team-display {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 30px;
        }

        .team-box {
            width: 45%;
            border: 2px solid #444;
            border-radius: 10px;
            padding: 10px;
            min-height: 250px;
        }

        .team-red { border-color: var(--red-color); }
        .team-blue { border-color: var(--blue-color); }

        .team-title {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .team-red .team-title { color: var(--red-color); }
        .team-blue .team-title { color: var(--blue-color); }

        .position-slot {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            padding: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            height: 50px;
            cursor: pointer;
            position: relative;
        }
        
        .position-slot:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* 스핀 중 클릭 방지 */
        .slots-locked .position-slot {
            pointer-events: none;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .pos-icon {
            width: 40px;
            height: 40px;
            margin-right: 10px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .slot-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            flex-grow: 1;
        }
        
        .slot-pos-name {
            font-size: 0.8rem;
            color: #aaa;
        }
        
        .slot-user-name {
            font-size: 1.1rem;
            font-weight: bold;
            height: 1.5em; /* Min height to maintain layout */
        }

        /* Dropdown for manual assignment */
        .user-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            background-color: #333;
            border: 1px solid #555;
            border-radius: 0 0 5px 5px;
            z-index: 100;
            display: none;
        }
        
        .user-dropdown.show {
            display: block;
        }
        
        .dropdown-item {
            padding: 8px 10px;
            cursor: pointer;
            border-bottom: 1px solid #444;
        }
        
        .dropdown-item:hover {
            background-color: #555;
        }
        
        .dropdown-item.clear {
            color: #ff8888;
            font-style: italic;
        }

        .spin-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 40px;
            width: 100%;
        }

        #spin-btn {
            padding: 15px 60px;
            font-size: 1.5rem;
            background-color: #f0d028;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(240, 208, 40, 0.3);
            margin-top: 20px;
        }

        #spin-btn.stopping {
            background-color: #ff4d4d;
            color: white;
        }

        #spin-btn:disabled {
            background-color: #555;
            color: #aaa;
            cursor: not-allowed;
            box-shadow: none;
        }

        #remaining-users-container {
            margin-top: 20px;
            text-align: center;
            width: 100%;
        }

        .remaining-title {
            font-size: 1.2rem;
            color: #aaa;
            margin-bottom: 10px;
        }

        #remaining-count {
            color: #f0d028;
            font-weight: bold;
        }

        #remaining-list {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .remaining-user-tag {
            background-color: #333;
            border: 1px solid #555;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
            color: #ccc;
        }

        /* Slot Machine Styles */
        .slot-machine-container {
            display: flex;
            gap: 20px;
            padding: 20px;
            background: #222;
            border-radius: 15px;
            border: 5px solid #444;
            box-shadow: inset 0 0 20px #000;
            position: relative;
        }

        .slot-window {
            width: 200px;
            height: 120px; /* Visible height */
            overflow: hidden;
            background: #111;
            border: 2px solid #555;
            border-radius: 8px;
            position: relative;
        }

        .slot-reel {
            display: flex;
            flex-direction: column;
            will-change: transform;
            /* Will be animated via transform */
        }

        .slot-item {
            height: 120px; /* Same as window height for single item view */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #fff;
            box-sizing: border-box;
            border-bottom: 1px solid #333;
        }
        
        .slot-item img {
            height: 80px;
            width: auto;
        }

        .slot-label {
            text-align: center;
        }

        .slot-header {
            text-align: center;
            font-size: 1.2rem;
            color: #888;
            margin-bottom: 5px;
        }

        .slot-column {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #reset-btn {
            padding: 10px 30px;
            font-size: 1.2rem;
            background-color: #555;
            color: #fff;
            border: 2px solid #777;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 30px;
            transition: background-color 0.2s;
        }

        #reset-btn:hover {
            background-color: #777;
        }
    </style>
</head>
<body>

    <div id="title-container">
        <img src="./assets/title.png" alt="League of Legends Custom Match Tool">
    </div>

    <!-- STEP 1: 유저 선택 -->
    <div id="user-selection">
        <div class="selection-container">
            <!-- Preset Users -->
            <div class="user-grid" id="preset-user-grid">
                <!-- 동적 생성 -->
            </div>

            <!-- Divider (Hidden by default) -->
            <div class="divider" id="custom-divider" style="display: none;"></div>

            <!-- Custom Users (Hidden by default) -->
            <div class="user-grid" id="custom-user-grid" style="display: none;">
                <!-- 동적 생성 -->
            </div>
        </div>

        <div class="controls-area">
            <button id="confirm-btn">확인</button>
            
            <div class="custom-setting-area">
                <label for="custom-count-select">커스텀 인원 추가</label>
                <select id="custom-count-select">
                    <option value="0" selected>0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                </select>
            </div>
        </div>
    </div>

    <!-- STEP 2: 룰렛 -->
    <div id="roulette-container">
        <button id="reset-btn">RESET</button>

        <div class="team-display">
            <div class="team-box team-red">
                <div class="team-title">RED TEAM</div>
                <div id="red-slots">
                    <!-- 포지션 슬롯 5개 -->
                </div>
            </div>
            <div class="team-box team-blue">
                <div class="team-title">BLUE TEAM</div>
                <div id="blue-slots">
                    <!-- 포지션 슬롯 5개 -->
                </div>
            </div>
        </div>

        <div class="spin-controls">
            <div class="slot-machine-container">
                <div class="slot-column">
                    <div class="slot-header">PLAYER</div>
                    <div class="slot-window">
                        <div class="slot-reel" id="reel-user"></div>
                    </div>
                </div>
                
                <div class="slot-column">
                    <div class="slot-header">TEAM</div>
                    <div class="slot-window">
                        <div class="slot-reel" id="reel-team"></div>
                    </div>
                </div>

                <div class="slot-column">
                    <div class="slot-header">POSITION</div>
                    <div class="slot-window">
                        <div class="slot-reel" id="reel-pos"></div>
                    </div>
                </div>
            </div>
            
            <button id="spin-btn">Spin</button>
            
            <div id="remaining-users-container">
                <div class="remaining-title">남은 인원: <span id="remaining-count">0</span>명</div>
                <div id="remaining-list"></div>
            </div>
        </div>
    </div>

    <script>
        // 데이터 정의
        const presetUsersData = [
            { name: "한세긴", id: "rose0957" },
            { name: "나비", id: "navixx" },
            { name: "송밤", id: "s07o24" },
            { name: "크앙희", id: "9wang2" },
            { name: "다니얀", id: "daniyan1030" },
            { name: "밤베", id: "bambe53" },
            { name: "밤새나", id: "bamsaena" },
            { name: "요코링", id: "yokoring03" },
            { name: "윰로로", id: "yumroro" },
            { name: "찌로", id: "ch1ch1r0" },
            { name: "프하", id: "peuhaha" },
            { name: "호발", id: "hobal115end" },
            { name: "공도리", id: "swcmnb67" },
            { name: "소호", id: "d0hxe823" },
            { name: "한세현", id: "kangturtle" }
        ];

        const positions = ["top", "mid", "bottom", "support", "jungle"];
        const positionNames = {
            "top": "탑",
            "mid": "미드",
            "bottom": "바텀",
            "support": "서폿",
            "jungle": "정글"
        };
        
        // 상태 관리
        let activePresetIndices = new Set();
        let customUsers = []; // Array of { name: string, active: boolean }
        let assignedUsers = new Set(); // Globally assigned users (manual + roulette) 
        
        // 룰렛/팀 상태
        let redTeam = { top: null, jungle: null, mid: null, bottom: null, support: null };
        let blueTeam = { top: null, jungle: null, mid: null, bottom: null, support: null };
        let spinState = { team: false, user: false, pos: false };
        let isSpinning = false;
        let animationId = null;

        // DOM Elements
        const presetUserGrid = document.getElementById('preset-user-grid');
        const customUserGrid = document.getElementById('custom-user-grid');
        const customDivider = document.getElementById('custom-divider');
        const customCountSelect = document.getElementById('custom-count-select');
        const confirmBtn = document.getElementById('confirm-btn');
        const userSelection = document.getElementById('user-selection');
        const rouletteContainer = document.getElementById('roulette-container');
        const titleContainer = document.getElementById('title-container');
        const resetBtn = document.getElementById('reset-btn');
        const spinBtn = document.getElementById('spin-btn');
        const remainingCountEl = document.getElementById('remaining-count');
        const remainingListEl = document.getElementById('remaining-list');
        
        // Slot Elements
        const reelUser = document.getElementById('reel-user');
        const reelTeam = document.getElementById('reel-team');
        const reelPos = document.getElementById('reel-pos');
        
        // 커스텀 유저 아이콘 SVG
        const customUserSvg = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="#e3e3e3">
                <path d="M480-481q-66 0-108-42t-42-108q0-66 42-108t108-42q66 0 108 42t42 108q0 66-42 108t-108 42ZM160-160v-94q0-38 19-65t49-41q67-30 128.5-45T480-420q62 0 123 15.5t127.92 44.69q31.3 14.13 50.19 40.97Q800-292 800-254v94H160Zm60-60h520v-34q0-16-9.5-30.5T707-306q-64-31-117-42.5T480-360q-57 0-111 11.5T252-306q-14 7-23 21.5t-9 30.5v34Zm260-321q39 0 64.5-25.5T570-631q0-39-25.5-64.5T480-721q-39 0-64.5 25.5T390-631q0 39 25.5 64.5T480-541Zm0-90Zm0 411Z"/>
            </svg>
        `;

        // 초기화
        function init() {
            renderPresetUsers();
            
            // Custom Count Change Listener
            customCountSelect.addEventListener('change', (e) => {
                updateCustomUserCount(parseInt(e.target.value));
            });
            
            // Initialize with 0
            updateCustomUserCount(0);
            renderSlots();
        }

        function getProfileImgUrl(id) {
            const prefix = id.substring(0, 2);
            return `https://stimg.sooplive.co.kr/LOGO/${prefix}/${id}/m/${id}.webp`;
        }

        function renderPresetUsers() {
            presetUserGrid.innerHTML = '';
            presetUsersData.forEach((user, index) => {
                const item = document.createElement('div');
                item.className = 'user-item preset';
                item.innerHTML = `
                    <div class="user-icon">
                        <img src="${getProfileImgUrl(user.id)}" alt="${user.name}" loading="lazy">
                    </div>
                    <div class="user-name">${user.name}</div>
                `;
                item.onclick = () => togglePresetUser(index, item);
                presetUserGrid.appendChild(item);
            });
        }

        function togglePresetUser(index, element) {
            if (activePresetIndices.has(index)) {
                activePresetIndices.delete(index);
                element.classList.remove('active');
            } else {
                activePresetIndices.add(index);
                element.classList.add('active');
            }
            checkConfirmButton();
        }

        function updateCustomUserCount(count) {
            // Resize array, preserving existing data if possible
            if (count > customUsers.length) {
                for (let i = customUsers.length; i < count; i++) {
                    customUsers.push({ name: `Custom ${i + 1}`, active: false });
                }
            } else if (count < customUsers.length) {
                customUsers = customUsers.slice(0, count);
            }

            renderCustomUsers();
        }

        function renderCustomUsers() {
            customUserGrid.innerHTML = '';
            if (customUsers.length === 0) {
                customUserGrid.style.display = 'none';
                customDivider.style.display = 'none';
                return;
            }

            customUserGrid.style.display = 'grid';
            customDivider.style.display = 'block';

            customUsers.forEach((user, index) => {
                const item = document.createElement('div');
                item.className = 'user-item custom';
                if (user.active) item.classList.add('active');

                // Icon part
                const iconDiv = document.createElement('div');
                iconDiv.className = 'user-icon';
                iconDiv.innerHTML = customUserSvg;
                iconDiv.onclick = () => toggleCustomUser(index, item);

                // Input part
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'custom-name-input';
                input.value = user.name;
                
                input.onchange = (e) => {
                    customUsers[index].name = e.target.value;
                };
                input.onfocus = () => {
                    // Optional: Highlight
                };

                item.appendChild(iconDiv);
                item.appendChild(input);
                customUserGrid.appendChild(item);
            });
        }

        function toggleCustomUser(index, element) {
            customUsers[index].active = !customUsers[index].active;
            if (customUsers[index].active) {
                element.classList.add('active');
            } else {
                element.classList.remove('active');
            }
            checkConfirmButton();
        }

        function getSelectedUserNames() {
            const presetNames = Array.from(activePresetIndices).map(i => presetUsersData[i].name);
            const customNames = customUsers.filter(u => u.active).map(u => u.name);
            return [...presetNames, ...customNames];
        }

        function checkConfirmButton() {
            // 10 users required for 5v5
            if (getSelectedUserNames().length >= 10) {
                confirmBtn.classList.add('enabled');
            } else {
                confirmBtn.classList.remove('enabled');
            }
        }

        confirmBtn.onclick = () => {
            if (!confirmBtn.classList.contains('enabled')) return;
            userSelection.style.display = 'none';
            titleContainer.style.display = 'none';
            rouletteContainer.style.display = 'flex';
            
            setupSlots();
            renderSlots(); // Update remaining users list immediately
        };

        resetBtn.onclick = () => {
            if (confirm("룰렛을 초기화하고 유저 선택 화면으로 돌아갑니까?")) {
                // Clear roulette state
                assignedUsers.clear();
                redTeam = { top: null, jungle: null, mid: null, bottom: null, support: null };
                blueTeam = { top: null, jungle: null, mid: null, bottom: null, support: null };
                renderSlots();
                
                // Show selection screen
                rouletteContainer.style.display = 'none';
                titleContainer.style.display = 'block';
                userSelection.style.display = 'flex';
                
                // Note: customUsers array and activePresetIndices are NOT cleared, preserving settings.
            }
        };

        // --- Roulette & Logic (Slot Machine) ---

        function renderSlots() {
            const redSlots = document.getElementById('red-slots');
            const blueSlots = document.getElementById('blue-slots');
            redSlots.innerHTML = '';
            blueSlots.innerHTML = '';

            positions.forEach(pos => {
                redSlots.appendChild(createSlotElement('red', pos));
                blueSlots.appendChild(createSlotElement('blue', pos));
            });
            
            updateRemainingUsers();
        }

        function updateRemainingUsers() {
            if (!remainingCountEl || !remainingListEl) return;
            
            const allSelected = getSelectedUserNames();
            // Filter out users who are currently assigned to any slot
            const availableUsers = allSelected.filter(u => !assignedUsers.has(u));
            
            remainingCountEl.innerText = availableUsers.length;
            remainingListEl.innerHTML = '';
            
            availableUsers.forEach(user => {
                const tag = document.createElement('div');
                tag.className = 'remaining-user-tag';
                tag.innerText = user;
                remainingListEl.appendChild(tag);
            });
        }

        function createSlotElement(team, pos) {
            const container = document.createElement('div');
            container.className = 'position-slot';
            container.dataset.team = team;
            container.dataset.pos = pos;

            const assignedName = (team === 'red' ? redTeam[pos] : blueTeam[pos]) || '';

            container.innerHTML = `
                <div class="pos-icon" style="background-image: url('./assets/${pos}.png')"></div>
                <div class="slot-content">
                    <div class="slot-pos-name">${positionNames[pos]}</div>
                    <div class="slot-user-name">${assignedName}</div>
                </div>
            `;

            container.onclick = (e) => {
                // Prevent dropdown opening if clicking existing dropdown
                if (e.target.closest('.user-dropdown')) return;
                openUserDropdown(container, team, pos);
            };

            return container;
        }

        function openUserDropdown(slotElement, team, pos) {
            // Close any existing dropdowns
            closeAllDropdowns();

            const dropdown = document.createElement('div');
            dropdown.className = 'user-dropdown show';

            const allSelectedUsers = getSelectedUserNames();
            
            // "선택 안함" 옵션
            const clearOption = document.createElement('div');
            clearOption.className = 'dropdown-item clear';
            clearOption.innerText = '(선택 해제)';
            clearOption.onclick = () => {
                manualAssign(team, pos, null);
                dropdown.remove();
            };
            dropdown.appendChild(clearOption);

            allSelectedUsers.forEach(user => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.innerText = user;
                
                // If user is already assigned somewhere else, maybe mark it?
                if (assignedUsers.has(user)) {
                    item.style.opacity = '0.5';
                    item.innerText += ' (이미 배정됨)';
                }

                item.onclick = (e) => {
                    e.stopPropagation();
                    manualAssign(team, pos, user);
                    dropdown.remove();
                };
                dropdown.appendChild(item);
            });

            slotElement.appendChild(dropdown);
            
            // Click outside to close
            document.addEventListener('click', function close(e) {
                if (!slotElement.contains(e.target)) {
                    dropdown.remove();
                    document.removeEventListener('click', close);
                }
            });
        }

        function closeAllDropdowns() {
            document.querySelectorAll('.user-dropdown').forEach(el => el.remove());
        }

        function manualAssign(team, pos, userName) {
            // 1. Remove previous user from this slot if any
            const prevUser = team === 'red' ? redTeam[pos] : blueTeam[pos];
            if (prevUser) {
                assignedUsers.delete(prevUser);
            }

            // 2. If assigning a new user
            if (userName) {
                // Check if this user is already assigned elsewhere and remove them from there
                if (assignedUsers.has(userName)) {
                    // Find and clear
                    for (const p of positions) {
                        if (redTeam[p] === userName) redTeam[p] = null;
                        if (blueTeam[p] === userName) blueTeam[p] = null;
                    }
                }
                assignedUsers.add(userName);
            }

            // 3. Assign
            if (team === 'red') redTeam[pos] = userName;
            else blueTeam[pos] = userName;

            // 4. Update UI
            renderSlots();
        }

        // Slot Machine State
        const slotHeight = 120; // Matches CSS .slot-item height
        let slotAnimationIds = {};
        let slotOffsets = { user: 0, team: 0, pos: 0 };
        let slotSpeeds = { user: 0, team: 0, pos: 0 };
        const MAX_SPEED = 40; // Max pixels per frame
        
        function setupSlots() {
            const allSelected = getSelectedUserNames();
            // Populate reels
            
            // 1. User Reel
            populateReel(reelUser, allSelected, 'user');
            
            // 2. Team Reel
            populateReel(reelTeam, ['RED', 'BLUE'], 'team');
            
            // 3. Pos Reel
            populateReel(reelPos, positions, 'pos');
        }
        
        function populateReel(reelEl, items, type) {
            reelEl.innerHTML = '';
            // Duplicate list MANY times to allow smooth long spins and stops
            // 50 iterations * 5 items = 250 items. 250 * 120px = 30,000px. Enough.
            
            let content = [];
            for(let i=0; i<50; i++) {
                content = content.concat(items);
            }
            
            content.forEach(item => {
                const el = document.createElement('div');
                el.className = 'slot-item';
                
                if (type === 'pos') {
                    el.innerHTML = `<img src="./assets/${item}.png" alt="${item}"><div class="slot-label">${positionNames[item]}</div>`;
                } else if (type === 'team') {
                     el.innerHTML = `<div style="color: ${item === 'RED' ? 'var(--red-color)' : 'var(--blue-color)'}">${item}</div>`;
                } else {
                    el.innerText = item;
                }
                
                reelEl.appendChild(el);
            });
            
            // For downward movement, we start in the middle of the reel
            const halfHeight = (reelEl.scrollHeight / 2);
            reelEl.style.transform = `translateY(-${halfHeight}px)`;
            reelEl.style.transition = 'none';
            slotOffsets[type] = halfHeight;
        }

        spinBtn.onclick = () => {
            if (!isSpinning) {
                // Pre-check
                const availableRed = positions.filter(p => !redTeam[p]);
                const availableBlue = positions.filter(p => !blueTeam[p]);
                
                if (availableRed.length === 0 && availableBlue.length === 0) {
                    alert("모든 포지션이 결정되었습니다!");
                    return;
                }

                const allSelected = getSelectedUserNames();
                const availableUsers = allSelected.filter(u => !assignedUsers.has(u));

                if (availableUsers.length === 0) {
                    alert("남은 유저가 없습니다.");
                    return;
                }

                startSpin();
            } else {
                stopSpin();
            }
        };

        function startSpin() {
            isSpinning = true;
            spinBtn.innerText = 'Stop';
            spinBtn.classList.add('stopping');
            spinBtn.disabled = true; // Temporary disable to prevent rapid clicks
            setTimeout(() => spinBtn.disabled = false, 500);
            
            // 포지션 슬롯 클릭 잠금
            document.getElementById('red-slots').classList.add('slots-locked');
            document.getElementById('blue-slots').classList.add('slots-locked');

            // Reset transitions
            [reelUser, reelTeam, reelPos].forEach(el => el.style.transition = 'none');
            
            // Reset speeds
            slotSpeeds = { user: 0, team: 0, pos: 0 };
            
            const animate = (type, reelEl) => {
                const totalHeight = reelEl.scrollHeight;
                const halfHeight = totalHeight / 2;
                // Buffer height: Reset loop when we have this much space left at the top.
                // 50 copies * 5 items * 120px = 30000px. halfHeight = 15000px.
                // We want to ensure we always have at least ~3000px (25 items) above us to scroll into during stop.
                const BUFFER_HEIGHT = 3000; 
                
                const step = () => {
                    if (!isSpinning && slotSpeeds[type] === 0) return; // Stopped

                    // Acceleration
                    if (slotSpeeds[type] < MAX_SPEED) {
                        slotSpeeds[type] += 1; // Ramp up
                    }

                    // Move DOWN: decrease offset
                    slotOffsets[type] -= slotSpeeds[type];
                    
                    // Loop logic: if we pass the buffer point, jump back to lower half
                    // We jump by exactly halfHeight (seamless)
                    if (slotOffsets[type] <= BUFFER_HEIGHT) {
                        slotOffsets[type] += halfHeight;
                    }
                    
                    reelEl.style.transform = `translateY(-${slotOffsets[type]}px)`;
                    
                    if (isSpinning || slotSpeeds[type] > 0) {
                        slotAnimationIds[type] = requestAnimationFrame(step);
                    }
                };
                step();
            };

            animate('user', reelUser);
            animate('team', reelTeam);
            animate('pos', reelPos);
        }

        function stopSpin() {
            isSpinning = false; // Logic flag
            spinBtn.disabled = true;
            spinBtn.innerText = 'Spinning...';

            // Determine Result
            const availableRed = positions.filter(p => !redTeam[p]);
            const availableBlue = positions.filter(p => !blueTeam[p]);
            
            let team;
            if (availableRed.length > 0 && availableBlue.length > 0) {
                team = Math.random() > 0.5 ? 'red' : 'blue';
            } else if (availableRed.length > 0) {
                team = 'red';
            } else {
                team = 'blue';
            }

            const teamAvailablePos = team === 'red' ? availableRed : availableBlue;
            const selectedPos = teamAvailablePos[Math.floor(Math.random() * teamAvailablePos.length)];

            const allSelected = getSelectedUserNames();
            const availableUsers = allSelected.filter(u => !assignedUsers.has(u));
            const selectedUser = availableUsers[Math.floor(Math.random() * availableUsers.length)];

            // Helper to stop a reel
            const stopReel = (type, targetItem, itemsList, delay) => {
                setTimeout(() => {
                    cancelAnimationFrame(slotAnimationIds[type]);
                    
                    const reelEl = (type === 'user' ? reelUser : (type === 'team' ? reelTeam : reelPos));
                    
                    let currentOffset = slotOffsets[type];
                    const itemsLength = itemsList.length;
                    const targetBaseIndex = itemsList.indexOf(targetItem);
                    
                    // Moving DOWN means finalOffset < currentOffset
                    const currentIndex = currentOffset / slotHeight;
                    // We want to land at least 15 items "earlier" (scrolling down visually)
                    // Using floor ensures we snap to grid
                    let targetIndex = Math.floor(currentIndex) - 15;
                    
                    // Adjust to match the correct item
                    // targetIndex might be e.g. 100.
                    // 100 % length should be targetBaseIndex
                    let remainder = targetIndex % itemsLength;
                    // JS modulo of negative numbers is negative. e.g. -13 % 10 = -3.
                    if (remainder < 0) remainder += itemsLength;

                    let diff = remainder - targetBaseIndex;
                    if (diff < 0) diff += itemsLength;
                    
                    targetIndex -= diff;
                    
                    // Calculate final pixel offset
                    const finalOffset = targetIndex * slotHeight;
                    
                    reelEl.style.transition = 'transform 2.5s cubic-bezier(0.1, 0, 0.1, 1)';
                    reelEl.style.transform = `translateY(-${finalOffset}px)`;
                    
                    slotOffsets[type] = finalOffset;

                }, delay);
            };
            
            // Delays for sequence: Name -> Team -> Pos
            const delayUser = 0;
            const delayTeam = 1500;
            const delayPos = 3000;
            const finishDelay = 6000;

            stopReel('user', selectedUser, allSelected, delayUser);
            stopReel('team', team.toUpperCase(), ['RED', 'BLUE'], delayTeam);
            stopReel('pos', selectedPos, positions, delayPos);
            
            // Finalize
            setTimeout(() => {
                if (team === 'red') redTeam[selectedPos] = selectedUser;
                else blueTeam[selectedPos] = selectedUser;
                assignedUsers.add(selectedUser);
                
                // 포지션 슬롯 클릭 잠금 해제
                document.getElementById('red-slots').classList.remove('slots-locked');
                document.getElementById('blue-slots').classList.remove('slots-locked');

                renderSlots();
                
                spinBtn.innerText = 'Spin';
                spinBtn.classList.remove('stopping');
                spinBtn.disabled = false;
                
            }, finishDelay);
        }

        init();
    </script>
</body>
</html>